package service

import (
	"boilerplate-backend-go/dto/request"
	"boilerplate-backend-go/dto/response"
	"context"
	"database/sql"
	"errors"
	"fmt"
	"time"

	"go.uber.org/zap"
)

type OrderService interface {
	SearchOrder(ctx context.Context, req request.SearchOrder) (*response.SearchOrderResponse, error)
	CreateBeforeReturnOrder(ctx context.Context, req request.CreateBeforeReturnOrder, userID string) (*response.BeforeReturnOrderResponse, error)
}

func (srv service) SearchOrder(ctx context.Context, req request.SearchOrder) (*response.SearchOrderResponse, error) {
	srv.logger.Info("üîé Searching for Order",
		zap.String("SoNo", req.SoNo),
		zap.String("OrderNo", req.OrderNo),
	)

	if req.SoNo == "" && req.OrderNo == "" {
		err := errors.New("either SoNo or OrderNo must be provided")
		srv.logger.Warn("‚ö†Ô∏è Invalid request - Missing parameters", zap.Error(err))
		return nil, err
	}

	order, err := srv.orderRepo.SearchOrder(ctx, req)
	if err != nil {
		if errors.Is(err, sql.ErrNoRows) {
			srv.logger.Warn("‚ö†Ô∏è No Sale Order found",
				zap.String("SoNo", req.SoNo),
				zap.String("OrderNo", req.OrderNo),
			)
			return nil, sql.ErrNoRows
		}

		srv.logger.Error("‚ùå Failed to search Order",
			zap.String("SoNo", req.SoNo),
			zap.String("OrderNo", req.OrderNo),
			zap.Error(err),
		)
		return nil, fmt.Errorf("failed to retrieve order: %w", err)
	}

	srv.logger.Info("‚úÖ Order found",
		zap.String("SoNo", order.SoNo),
		zap.String("OrderNo", order.OrderNo),
		zap.Int("TotalItems", len(order.Items)),
	)

	return order, nil
}

func (srv service) CreateBeforeReturnOrder(ctx context.Context, req request.CreateBeforeReturnOrder, userID string) (*response.BeforeReturnOrderResponse, error) {
	srv.logger.Info("üìù Creating BeforeReturnOrder",
		zap.String("OrderNo", req.OrderNo),
		zap.String("SoNo", req.SoNo),
		zap.Int("TotalItems", len(req.Items)),
		zap.String("CreateBy", userID),
	)

	// ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏∑‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
	if len(req.Items) == 0 {
		err := errors.New("‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
		srv.logger.Warn("‚ö†Ô∏è No items provided", zap.Error(err))
		return nil, err
	}

	// ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö `ReturnDate` ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏î‡∏µ‡∏ï
	if req.ReturnDate.Before(time.Now()) {
		err := errors.New("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï")
		srv.logger.Warn("‚ö†Ô∏è Invalid ReturnDate", zap.Error(err))
		return nil, err
	}

	// ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Default `SoStatus` ‡πÅ‡∏•‡∏∞ `MkpStatus`
	if req.SoStatus == "" {
		req.SoStatus = "open order"
	}
	if req.MkpStatus == "" {
		req.MkpStatus = "complete"
	}

	// ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î `CreateBy`
	for i := range req.Items {
		req.Items[i].CreateBy = userID
	}

	// üîπ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Repository Layer
	err := srv.orderRepo.CreateBeforeReturnOrder(ctx, req, userID)
	if err != nil {
		srv.logger.Error("‚ùå Failed to create BeforeReturnOrder", zap.Error(err))
		return nil, fmt.Errorf("failed to create return order: %w", err)
	}

	// ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á
	order, err := srv.orderRepo.GetBeforeReturnOrder(ctx, req.OrderNo)
	if err != nil {
		srv.logger.Error("‚ùå Failed to fetch created BeforeReturnOrder", zap.Error(err))
		return nil, fmt.Errorf("failed to retrieve created order: %w", err)
	}

	// ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
	items, err := srv.orderRepo.GetBeforeReturnOrderItems(ctx, req.OrderNo)
	if err != nil {
		srv.logger.Error("‚ùå Failed to fetch created BeforeReturnOrderItems", zap.Error(err))
		return nil, fmt.Errorf("failed to retrieve created order items: %w", err)
	}

	order.Items = items

	srv.logger.Info("‚úÖ BeforeReturnOrder created successfully",
		zap.String("OrderNo", order.OrderNo),
		zap.String("SoNo", order.SoNo),
		zap.Int("TotalItems", len(order.Items)),
	)

	return order, nil
}
